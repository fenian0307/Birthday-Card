<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿæ—¥å¿«æ¨‚ ğŸ‚</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* å½±ç‰‡å±¤å„ªåŒ– */
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            will-change: opacity; /* GPU åŠ é€Ÿ */
        }

        #timeline1 { z-index: 10; }
        #timeline2 { z-index: 5; }
        video.visible { opacity: 1; }

        /* é–‹å§‹ç•«é¢ */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: opacity 1s ease;
        }

        #wish-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: #fff;
            padding: 25px 45px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            line-height: 1.6;
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3); 
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 12px 48px rgba(255, 215, 0, 0.6); 
            }
        }

        #wish-btn span {
            display: block;
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 8px;
        }

        /* æç¤ºæ–‡å­— */
        .hint {
            position: absolute;
            bottom: 12%;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.85);
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 50;
            pointer-events: none;
            padding: 0 20px;
            line-height: 1.6;
        }

        /* è³€å¡ç•«é¢ */
        #card-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            transition: opacity 2s ease;
            padding: 40px 30px;
        }

        #message {
            color: #fff;
            font-size: 1.35rem;
            line-height: 2;
            letter-spacing: 1.5px;
            margin-bottom: 40px;
            text-align: center;
            text-shadow: 0 2px 15px rgba(0,0,0,0.6);
            max-width: 90%;
        }

        #signature {
            width: 180px;
            height: auto;
            opacity: 0;
            transition: opacity 2s ease;
            margin-top: 20px;
        }
        
        #signature path {
            fill: none;
            stroke: #ffd700;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.5));
        }
        
        #signature path.animate {
            animation: sign 3s ease-out forwards;
        }
        
        @keyframes sign { 
            to { stroke-dashoffset: 0; } 
        }

        /* ç‰ˆæœ¬æ¨™ç±¤ */
        #version-tag {
            position: absolute;
            bottom: 8px;
            right: 8px;
            color: rgba(255,255,255,0.25);
            font-size: 10px;
            z-index: 100;
            pointer-events: none;
        }

        /* è¼‰å…¥æç¤º */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
            z-index: 998;
        }
    </style>
</head>
<body>

<div id="container">
    <div id="version-tag">Ver 13.0 Optimized</div>

    <!-- å½±ç‰‡å±¤ -->
    <video id="timeline1" playsinline webkit-playsinline loop muted preload="auto"></video>
    <video id="timeline2" playsinline webkit-playsinline muted preload="none"></video>

    <!-- é–‹å§‹ç•«é¢ -->
    <div id="start-screen">
        <button id="wish-btn">
            æŒ‰é€™è£¡è¨±é¡˜
            <span>è¨±å®Œé¡˜åˆ¥å¿˜äº†å¹è Ÿç‡­ (å¤§åŠ›å¹)</span>
        </button>
    </div>

    <!-- æç¤ºæ–‡å­— -->
    <div id="blow-hint" class="hint"></div>

    <!-- è³€å¡ç•«é¢ -->
    <div id="card-screen">
        <div id="message"></div>
        <svg id="signature" viewBox="0 0 320 120">
            <path d="M50,90 Q60,20 70,90 Q80,50 90,70 L100,90 M105,70 L115,70 M120,90 L120,40 L130,90 M140,90 L140,40 L150,90 M160,70 Q170,60 180,70 T190,70 L200,70 Q210,60 200,80 T190,90" />
        </svg>
    </div>

    <!-- éŸ³è¨Š -->
    <audio id="narration" preload="auto"></audio>
    <audio id="bgm" preload="auto" loop></audio>
</div>

<script>
    // ========== å…¨åŸŸè®Šæ•¸ ==========
    const startScreen = document.getElementById('start-screen');
    const wishBtn = document.getElementById('wish-btn');
    const timeline1 = document.getElementById('timeline1');
    const timeline2 = document.getElementById('timeline2');
    const cardScreen = document.getElementById('card-screen');
    const messageEl = document.getElementById('message');
    const signature = document.getElementById('signature');
    const signaturePath = signature.querySelector('path');
    const narration = document.getElementById('narration');
    const bgm = document.getElementById('bgm');
    const blowHint = document.getElementById('blow-hint');
    
    let audioContext, analyser, microphone, micStream;
    let isBlowing = false;
    let animationId = null;

    // ========== è³€è©è…³æœ¬ ==========
    const greetingText = `è¦ªæ„›çš„ï¼Œç”Ÿæ—¥å¿«æ¨‚ï¼

æ„Ÿè¬åœ°å¿ƒå¼•åŠ›ï¼Œ
è®“å¦³åœ¨ 12/12 èµ°é€²æˆ‘çš„ç”Ÿå‘½ã€‚

æº«æŸ”çš„å¦³ï¼Œ
ç¸½æ˜¯è®“æˆ‘å¿ƒç–¼ã€è®“æˆ‘ç˜‹ç‹‚ï¼Œ
æˆ‘æœƒç›¡æˆ‘å…¨åŠ›ï¼Œä¿è­·é€™æ¨£çš„å¦³ã€‚

æ¯å¤©æ¯å¤©ï¼Œéƒ½åœ¨ä¸€ç›´æƒ³è‘—å¦³...

1/7 è¦‹é¢ï¼Œ
æˆ‘æœƒæŠŠæ¬ å¦³çš„å¯µæ„›ï¼Œã€Œè¦ªè‡ªã€é€é”ã€‚

ä¹–ä¹–ç­‰æˆ‘å–”ï¼`;

    // ========== åˆå§‹åŒ– ==========
    window.addEventListener('load', () => {
        // è¨­å®šå½±ç‰‡ä¾†æº
        timeline1.src = 'Timeline1.mp4?v=' + Date.now();
        timeline2.src = 'Timeline2.mp4?v=' + Date.now();
        narration.src = 'narration.mp3?v=' + Date.now();
        bgm.src = 'cute.mp3?v=' + Date.now();
        
        // éŒ¯èª¤è™•ç†
        timeline1.onerror = () => console.warn('Timeline1 è¼‰å…¥å¤±æ•—');
        timeline2.onerror = () => console.warn('Timeline2 è¼‰å…¥å¤±æ•—');
    });

    // ========== 1. é»æ“ŠæŒ‰éˆ• ==========
    wishBtn.addEventListener('click', startExperience, { once: true });

    function startExperience() {
        // åœæ­¢æŒ‰éˆ•å‹•ç•«
        wishBtn.style.animation = 'none';
        
        // éš±è—é–‹å§‹ç•«é¢
        startScreen.style.opacity = '0';
        setTimeout(() => {
            startScreen.style.display = 'none';
        }, 1000);
        
        // æ’­æ”¾ç¬¬ä¸€å€‹å½±ç‰‡
        timeline1.classList.add('visible');
        timeline1.play().catch(() => {
            timeline1.muted = true;
            timeline1.play();
        });

        // å»¶é²è¼‰å…¥ç¬¬äºŒå€‹å½±ç‰‡
        setTimeout(() => {
            timeline2.load();
        }, 800);

        // é¡¯ç¤ºæç¤º
        blowHint.innerHTML = "å°è‘—æ‰‹æ©Ÿåº•éƒ¨éº¥å…‹é¢¨å¹æ°£å¹ç†„è Ÿç‡­<br><span style='font-size:0.9em;opacity:0.8'>(æˆ–ç›´æ¥é»æ“Šç•«é¢)</span>";
        blowHint.style.opacity = '1';

        // éŸ³è¨Šè§£é–
        unlockAudio();

        // å•Ÿå‹•éº¥å…‹é¢¨åµæ¸¬
        setTimeout(initMicrophone, 1000);

        // å‚™ç”¨ï¼šé»æ“Šè§¸ç™¼
        setTimeout(() => {
            document.addEventListener('click', manualBlow, { once: true });
            document.addEventListener('touchstart', manualBlow, { once: true });
        }, 1500);
    }

    // ========== éŸ³è¨Šè§£é– ==========
    function unlockAudio() {
        [timeline2, narration, bgm].forEach(media => {
            if (media) {
                media.play().then(() => {
                    media.pause();
                    media.currentTime = 0;
                }).catch(() => {});
            }
        });
    }

    // ========== 2. éº¥å…‹é¢¨åµæ¸¬ ==========
    async function initMicrophone() {
        try {
            micStream = await navigator.mediaDevices.getUserMedia({ 
                audio: { 
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false 
                }
            });
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(micStream);
            microphone.connect(analyser);
            analyser.fftSize = 512;
            analyser.smoothingTimeConstant = 0.3;
            
            detectBlow();
            
        } catch (err) {
            console.warn('éº¥å…‹é¢¨å•Ÿç”¨å¤±æ•—:', err);
            blowHint.innerHTML = "è«‹ç›´æ¥é»æ“Šç•«é¢å¹ç†„è Ÿç‡­";
        }
    }

    function detectBlow() {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        let blowCount = 0;
        
        function checkAudio() {
            if (isBlowing) {
                cancelAnimationFrame(animationId);
                return;
            }
            
            analyser.getByteFrequencyData(dataArray);
            
            // è¨ˆç®—ä½é »èƒ½é‡ï¼ˆå¹æ°£ä¸»è¦åœ¨ä½é »ï¼‰
            let lowFreqSum = 0;
            for (let i = 0; i < bufferLength * 0.2; i++) {
                lowFreqSum += dataArray[i];
            }
            let average = lowFreqSum / (bufferLength * 0.2);

            // åµæ¸¬é–¾å€¼
            if (average > 50) {
                blowCount++;
                if (blowCount > 3) { // é€£çºŒåµæ¸¬åˆ°3æ¬¡
                    triggerBlowOut();
                    return;
                }
            } else {
                blowCount = Math.max(0, blowCount - 1);
            }
            
            animationId = requestAnimationFrame(checkAudio);
        }
        
        animationId = requestAnimationFrame(checkAudio);
    }

    function manualBlow() {
        if (!isBlowing) triggerBlowOut();
    }

    // ========== 3. åˆ‡æ›åˆ°å¹ç†„å½±ç‰‡ ==========
    function triggerBlowOut() {
        if (isBlowing) return;
        isBlowing = true;
        
        // æ¸…ç†è³‡æº
        cleanupMicrophone();
        
        // ç§»é™¤æç¤º
        blowHint.style.opacity = '0';

        // åˆ‡æ›å½±ç‰‡
        timeline2.style.zIndex = '100';
        timeline2.classList.add('visible');
        
        timeline2.play().then(() => {
            setTimeout(() => {
                timeline1.classList.remove('visible');
                timeline1.pause();
            }, 300);
        }).catch(err => {
            console.error('Timeline2 æ’­æ”¾å¤±æ•—:', err);
        });

        // å½±ç‰‡çµæŸå¾Œé¡¯ç¤ºè³€å¡
        timeline2.onended = () => {
            setTimeout(showCard, 500);
        };
    }

    function cleanupMicrophone() {
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        if (micStream) {
            micStream.getTracks().forEach(track => track.stop());
            micStream = null;
        }
        if (microphone) {
            microphone.disconnect();
            microphone = null;
        }
        if (audioContext && audioContext.state !== 'closed') {
            audioContext.close();
            audioContext = null;
        }
    }

    // ========== 4. é¡¯ç¤ºè³€å¡ ==========
    function showCard() {
        // æ·¡å‡ºå½±ç‰‡
        timeline2.style.opacity = '0';
        
        // é¡¯ç¤ºè³€å¡
        cardScreen.style.opacity = '1';
        cardScreen.style.pointerEvents = 'auto';

        // æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
        if (bgm) {
            bgm.volume = 0.25;
            bgm.play().catch(() => {});
        }

        // æ’­æ”¾å£ç™½
        if (narration) {
            narration.volume = 1.0;
            narration.play().catch(() => {});
            
            narration.onended = () => {
                if (bgm) fadeBgmVolume(0.25, 0.8, 3000);
            };
        }

        // æ‰“å­—æ©Ÿæ•ˆæœ
        setTimeout(() => {
            typeWriter(greetingText, 0);
        }, 800);
    }

    // ========== æ‰“å­—æ©Ÿæ•ˆæœï¼ˆå„ªåŒ–ç‰ˆï¼‰ ==========
    function typeWriter(text, index) {
        if (index >= text.length) {
            showSignature();
            return;
        }

        const char = text.charAt(index);
        
        if (char === '\n') {
            messageEl.appendChild(document.createElement('br'));
        } else {
            messageEl.appendChild(document.createTextNode(char));
        }

        // æ ¹æ“šæ¨™é»ç¬¦è™Ÿèª¿æ•´é€Ÿåº¦
        let delay = 80;
        if (char === 'ï¼Œ' || char === 'ã€‚' || char === 'ï¼' || char === 'ï¼Ÿ') {
            delay = 400;
        } else if (char === '\n') {
            delay = 600;
        }

        setTimeout(() => typeWriter(text, index + 1), delay);
    }

    // ========== é¡¯ç¤ºç°½å ==========
    function showSignature() {
        setTimeout(() => {
            signature.style.opacity = '1';
            signaturePath.classList.add('animate');
        }, 1000);
    }

    // ========== éŸ³é‡æ·¡å…¥æ·¡å‡º ==========
    function fadeBgmVolume(from, to, duration) {
        const steps = 50;
        const stepDuration = duration / steps;
        const increment = (to - from) / steps;
        let current = from;
        let step = 0;

        const fadeInterval = setInterval(() => {
            if (step >= steps) {
                clearInterval(fadeInterval);
                bgm.volume = to;
                return;
            }
            current += increment;
            bgm.volume = Math.max(0, Math.min(1, current));
            step++;
        }, stepDuration);
    }

    // ========== é˜²æ­¢æ„å¤–é›¢é–‹ ==========
    window.addEventListener('beforeunload', cleanupMicrophone);
</script>

</body>
</html>
