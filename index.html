<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Make a Wish</title>
    <style>
        /* CSS 樣式設定 */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 容器與層級管理 */
        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* 影片層 - 預設隱藏 */
        video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1s ease;
            z-index: 10;
        }

        /* 顯示狀態 */
        video.active {
            opacity: 1;
        }

        /* 起始按鈕層 */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            background: #000; /* 初始全黑背景 */
            transition: opacity 1s ease;
        }

        #wish-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 20px 40px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        }

        /* 賀卡文字層 */
        #card-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            opacity: 0;
            pointer-events: none;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); /* 深色質感背景 */
            transition: opacity 2s ease;
            padding: 40px;
            box-sizing: border-box;
            text-align: center;
        }

        /* 逐字顯示的文字 */
        #message {
            color: #fff;
            font-size: 1.5rem;
            line-height: 2;
            letter-spacing: 2px;
            margin-bottom: 50px;
            min-height: 100px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* 簽名樣式 (SVG) */
        #signature {
            width: 150px;
            height: auto;
            opacity: 0;
            transition: opacity 2s ease;
        }
        
        path {
            fill: none;
            stroke: #d4af37; /* 金色簽名 */
            stroke-width: 2;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: sign 3s forwards;
            animation-play-state: paused;
        }
        
        @keyframes sign {
            to { stroke-dashoffset: 0; }
        }

        /* 輔助提示文字 */
        .hint {
            position: absolute;
            bottom: 10%;
            color: rgba(255,255,255,0.5);
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<div id="container">
    
    <video id="timeline1" src="Timeline1.mov" playsinline loop muted preload="auto"></video>
    
    <video id="timeline2" src="Timeline2.mov" playsinline preload="auto"></video>

    <div id="start-screen">
        <button id="wish-btn">按這裡許願<br><span style="font-size:0.8em; opacity:0.8;">許完願別忘了吹蠟燭 (大力吹)</span></button>
    </div>

    <div id="blow-hint" class="hint">偵測麥克風中...請對著手機底部吹氣</div>

    <div id="card-screen">
        <div id="message"></div> <svg id="signature" viewBox="0 0 300 100">
            <path d="M40,80 Q50,10 60,80 Q70,40 80,60 L90,80 M95,60 L105,60 M110,80 L110,30 L120,80 M130,80 L130,30 L140,80 M150,60 Q160,50 170,60 T180,60 L190,60 Q200,50 190,70 T180,80" />
        </svg>
    </div>

    <audio id="narration" src="narration.mp3" preload="auto"></audio>

</div>

<script>
    // 變數設定
    const startScreen = document.getElementById('start-screen');
    const wishBtn = document.getElementById('wish-btn');
    const timeline1 = document.getElementById('timeline1');
    const timeline2 = document.getElementById('timeline2');
    const cardScreen = document.getElementById('card-screen');
    const messageEl = document.getElementById('message');
    const signature = document.getElementById('signature');
    const signaturePath = signature.querySelector('path');
    const narration = document.getElementById('narration');
    const blowHint = document.getElementById('blow-hint');

    // 賀詞內容 (請在此修改)
    const greetingText = "願你的每一個願望都能成真\n新的一年，平安喜樂\n生日快樂";
    const textSpeed = 100; // 文字出現速度 (毫秒)

    let audioContext;
    let analyser;
    let microphone;
    let isBlowing = false;

    // --- 步驟 1: 點擊按鈕 ---
    wishBtn.addEventListener('click', async () => {
        // 1. 初始化 AudioContext (必須在點擊事件中)
        try {
            await initMicrophone();
            
            // 2. 介面轉換
            startScreen.style.opacity = '0';
            setTimeout(() => { startScreen.style.display = 'none'; }, 1000);

            // 3. 播放蠟燭影片 (Timeline1)
            timeline1.classList.add('active');
            timeline1.play();
            
            // 顯示吹氣提示
            blowHint.style.opacity = '1';

            // 開始監聽吹氣
            detectBlow();

        } catch (err) {
            alert("需要麥克風權限才能吹蠟燭喔！請允許存取。");
            console.error(err);
        }
    });

    // --- 麥克風與吹氣偵測邏輯 ---
    async function initMicrophone() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        analyser.fftSize = 256;
    }

    function detectBlow() {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        function checkAudio() {
            if (isBlowing) return; // 已觸發則停止

            analyser.getByteFrequencyData(dataArray);
            
            // 計算音量平均值
            let sum = 0;
            for(let i = 0; i < bufferLength; i++) {
                sum += dataArray[i];
            }
            let average = sum / bufferLength;

            // 判斷是否為吹氣 (音量閾值，可依需求調整，通常 40-50 左右)
            // 吹氣會產生大量低頻噪音
            if (average > 45) { 
                triggerBlowOut();
            } else {
                requestAnimationFrame(checkAudio);
            }
        }
        checkAudio();
    }

    // --- 步驟 2: 觸發吹熄 ---
    function triggerBlowOut() {
        isBlowing = true;
        blowHint.style.opacity = '0';

        // 切換影片
        timeline1.style.opacity = '0'; // 淡出 loop
        timeline2.classList.add('active'); // 顯示 blow
        timeline2.play();

        // 監聽影片結束
        timeline2.onended = () => {
            showCard();
        };
    }

    // --- 步驟 3: 顯示賀卡與口白 ---
    function showCard() {
        // 淡出影片
        timeline2.style.opacity = '0';
        
        // 淡入賀卡
        cardScreen.style.opacity = '1';
        
        // 播放口白
        narration.play();
        
        // 開始打字機效果
        typeWriter(greetingText, 0);
    }

    // --- 打字機效果 ---
    function typeWriter(text, i) {
        if (i < text.length) {
            // 處理換行
            if (text.charAt(i) === '\n') {
                messageEl.innerHTML += '<br>';
            } else {
                messageEl.innerHTML += text.charAt(i);
            }
            
            // 根據口白長度，這裡可能需要動態調整速度
            // 如果希望嚴格對齊，需要更複雜的時間軸陣列，目前使用固定速度
            setTimeout(() => {
                typeWriter(text, i + 1);
            }, textSpeed);
        } else {
            // 文字打完後，顯示簽名
            showSignature();
        }
    }

    function showSignature() {
        signature.style.opacity = '1';
        signaturePath.style.animationPlayState = 'running';
    }

</script>

</body>
</html>