
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿæ—¥å¿«æ¨‚ ğŸ‚</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #000;
        }

        /* å½±ç‰‡å±¤ */
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            will-change: opacity;
        }

        /* Timeline1: åˆå§‹é€æ˜ï¼Œè¨­å®š 5ç§’æ·¡å…¥éæ¸¡ */
        #timeline1 { 
            z-index: 10; 
            opacity: 0; 
            transition: opacity 5s ease-in; /* é—œéµï¼š5ç§’æ·¡å…¥ */
        }

        /* Timeline2: åˆå§‹é€æ˜ï¼Œè¨­å®šå¿«é€Ÿåˆ‡æ› */
        #timeline2 { 
            z-index: 20; 
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        video.visible { opacity: 1 !important; }

        /* é–‹å§‹ç•«é¢ */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            background-color: #000;
            transition: opacity 1s ease;
        }

        #wish-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: #fff;
            padding: 25px 30px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            line-height: 1.6;
            text-align: center;
            max-width: 90%;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 12px 48px rgba(255, 215, 0, 0.6); }
        }

        #wish-btn span {
            display: block;
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 8px;
            color: #ffd700;
        }

        /* æç¤ºæ–‡å­— */
        .hint {
            position: absolute;
            bottom: 15%;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.85);
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 50;
            pointer-events: none;
            padding: 0 20px;
            line-height: 1.6;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* è³€å¡ç•«é¢ */
        #card-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            transition: opacity 2s ease;
            padding: 40px 30px;
        }

        #message {
            color: #fff;
            font-size: 1.35rem;
            line-height: 2;
            letter-spacing: 1.5px;
            margin-bottom: 40px;
            text-align: center;
            text-shadow: 0 2px 15px rgba(0,0,0,0.6);
            max-width: 90%;
        }

        #signature {
            width: 180px;
            height: auto;
            opacity: 0;
            transition: opacity 2s ease;
            margin-top: 20px;
        }
        
        #signature path {
            fill: none;
            stroke: #ffd700;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.5));
        }
        
        #signature path.animate {
            animation: sign 3s ease-out forwards;
        }
        
        @keyframes sign { to { stroke-dashoffset: 0; } }

        #version-tag {
            position: absolute;
            bottom: 8px;
            right: 8px;
            color: rgba(255,255,255,0.25);
            font-size: 10px;
            z-index: 100;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="container">
    <div id="version-tag">Ver 16.0 (Fixed Timeline/Mic)</div>

    <video id="timeline1" src="timeline1.mp4" playsinline webkit-playsinline loop muted preload="auto"></video>
    <video id="timeline2" src="timeline2.mp4" playsinline webkit-playsinline muted preload="none"></video>

    <div id="start-screen">
        <button id="wish-btn">
            è¨±é¡˜
            <span>è¨±å®Œé¡˜æœ›è¦è¨˜å¾—å¹è Ÿç‡­å“¦<br>ï¼ˆå¯èƒ½è¦å¹å¤§åŠ›ä¸€é»XDï¼‰</span>
        </button>
    </div>

    <div id="blow-hint" class="hint"></div>

    <div id="card-screen">
        <div id="message"></div>
        <svg id="signature" viewBox="0 0 320 120">
            <path d="M50,90 Q60,20 70,90 Q80,50 90,70 L100,90 M105,70 L115,70 M120,90 L120,40 L130,90 M140,90 L140,40 L150,90 M160,70 Q170,60 180,70 T190,70 L200,70 Q210,60 200,80 T190,90" />
        </svg>
    </div>

    <audio id="happyBD" src="happyBD.mp3" preload="auto"></audio>
    <audio id="narration" src="narration.mp3" preload="auto"></audio>
    <audio id="bgm" src="cute.mp3" preload="auto" loop></audio>
</div>

<script>
    const startScreen = document.getElementById('start-screen');
    const wishBtn = document.getElementById('wish-btn');
    const timeline1 = document.getElementById('timeline1');
    const timeline2 = document.getElementById('timeline2');
    const cardScreen = document.getElementById('card-screen');
    const messageEl = document.getElementById('message');
    const signature = document.getElementById('signature');
    const signaturePath = signature.querySelector('path');
    const narration = document.getElementById('narration');
    const bgm = document.getElementById('bgm');
    const happyBD = document.getElementById('happyBD');
    const blowHint = document.getElementById('blow-hint');
    
    let audioContext, analyser, microphone, micStream;
    let isBlowing = false;
    let animationId = null;

    const greetingText = `è¦ªæ„›çš„ï¼Œç”Ÿæ—¥å¿«æ¨‚ï¼

æ„Ÿè¬åœ°å¿ƒå¼•åŠ›ï¼Œ
è®“å¦³åœ¨ 12/12 èµ°é€²æˆ‘çš„ç”Ÿå‘½ã€‚

æº«æŸ”çš„å¦³ï¼Œ
ç¸½æ˜¯è®“æˆ‘å¿ƒç–¼ã€è®“æˆ‘ç˜‹ç‹‚ï¼Œ
æˆ‘æœƒç›¡æˆ‘å…¨åŠ›ï¼Œä¿è­·é€™æ¨£çš„å¦³ã€‚

æ¯å¤©æ¯å¤©ï¼Œéƒ½åœ¨ä¸€ç›´æƒ³è‘—å¦³...

1/7 è¦‹é¢ï¼Œ
æˆ‘æœƒæŠŠæ¬ å¦³çš„å¯µæ„›ï¼Œã€Œè¦ªè‡ªã€é€é”ã€‚

ä¹–ä¹–ç­‰æˆ‘å–”ï¼`;

    // éŒ¯èª¤ç›£è½
    timeline1.addEventListener('error', (e) => console.error('Timeline1 Error:', timeline1.error));
    timeline2.addEventListener('error', (e) => console.error('Timeline2 Error:', timeline2.error));

    // ========== 1. å•Ÿå‹•æµç¨‹ ==========
    wishBtn.addEventListener('click', startExperience, { once: true });

    function startExperience() {
        wishBtn.style.animation = 'none';
        
        // éš±è—é–‹å§‹ç•«é¢ (èƒŒæ™¯ä¿æŒé»‘)
        startScreen.style.opacity = '0';
        setTimeout(() => { startScreen.style.display = 'none'; }, 1000);
        
        // A. æ’­æ”¾éŸ³æ¨‚
        if (happyBD) {
            happyBD.volume = 1.0;
            happyBD.play().catch(e => console.warn("Audio play failed", e));
        }

        // B. è™•ç†å½±ç‰‡æ·¡å…¥ (é—œéµä¿®æ­£)
        // å…ˆç¢ºä¿å½±ç‰‡é–‹å§‹æ’­æ”¾ï¼Œå†åŸ·è¡Œ CSS opacity è½‰å ´
        timeline1.muted = true; // ç¢ºä¿éœéŸ³ä»¥å…è¨±è‡ªå‹•æ’­æ”¾
        timeline1.play().then(() => {
            console.log("Timeline1 playing, starting fade-in");
            // å¼·åˆ¶é‡ç¹ªä»¥ç¢ºä¿ transition ç”Ÿæ•ˆ
            timeline1.offsetHeight; 
            timeline1.classList.add('visible'); // è§¸ç™¼ 5ç§’ fade-in
        }).catch(err => {
            console.error("Timeline1 play failed:", err);
            // å¤±æ•—å‚™æ¡ˆï¼šç›´æ¥é¡¯ç¤º
            timeline1.style.opacity = '1';
        });

        // é è¼‰ç¬¬äºŒæ®µ
        setTimeout(() => timeline2.load(), 1000);

        // C. é å…ˆåˆå§‹åŒ– AudioContext (ä½†ä¸è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™)
        // é€™æ˜¯ç‚ºäº†åœ¨ç¨å¾Œä¸éœ€è¦ä½¿ç”¨è€…é»æ“Šå°±èƒ½è™•ç†éŸ³é »
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch(e) { console.log("AudioContext init warning"); }

        // è§£é–å…¶ä»–éŸ³é »
        unlockAudio();

        // å‚™ç”¨ï¼šå¦‚æœéŸ³æ¨‚æ’­å®Œé‚„æ²’å¹ï¼Œæä¾›é»æ“Šè§¸ç™¼
        setTimeout(() => {
            document.addEventListener('click', manualBlow, { once: true });
            document.addEventListener('touchstart', manualBlow, { once: true });
        }, 3000);
    }

    // ========== 2. éŸ³æ¨‚çµæŸå¾Œæ‰å•Ÿå‹•éº¥å…‹é¢¨ ==========
    happyBD.onended = () => {
        if (!isBlowing) {
            console.log("Birthday song ended. Requesting Mic...");
            // é¡¯ç¤ºæç¤ºæ–‡å­—
            blowHint.innerHTML = "ç¾åœ¨ï¼Œè«‹å°è‘—éº¥å…‹é¢¨å¹æ°£<br>æŠŠè Ÿç‡­å¹ç†„å§ï¼";
            blowHint.style.opacity = '1';
            
            // è«‹æ±‚æ¬Šé™
            initMicrophone();
        }
    };

    function unlockAudio() {
        [timeline2, narration, bgm].forEach(media => {
            if (media) {
                media.play().then(() => {
                    media.pause();
                    media.currentTime = 0;
                }).catch(() => {});
            }
        });
    }

    // ========== 3. éº¥å…‹é¢¨åµæ¸¬ ==========
    async function initMicrophone() {
        try {
            // åœ¨ iOS ä¸Šï¼Œå¦‚æœè·é›¢ä¸Šæ¬¡é»æ“Šå¤ªä¹…ï¼Œé€™å€‹å¯èƒ½æœƒè¢«æ“‹
            // ä½†å› ç‚ºæˆ‘å€‘æœ‰æ­£åœ¨æ’­æ”¾çš„ audio (happyBDå‰›çµæŸ)ï¼Œé€šå¸¸æœƒè¢«è¦–ç‚ºæ´»èº session
            micStream = await navigator.mediaDevices.getUserMedia({ 
                audio: { 
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false 
                }
            });
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(micStream);
            microphone.connect(analyser);
            analyser.fftSize = 512;
            analyser.smoothingTimeConstant = 0.3;
            
            detectBlow();
            
        } catch (err) {
            console.warn('éº¥å…‹é¢¨å•Ÿå‹•å¤±æ•— (å¯èƒ½å› æ¬Šé™æˆ–ç„¡æ‰‹å‹¢):', err);
            // å¦‚æœå¤±æ•—ï¼Œæ›´æ”¹æç¤ºæ–‡å­—å¼•å°é»æ“Š
            blowHint.innerHTML = "éº¥å…‹é¢¨æ¬Šé™æœªé–‹å•Ÿ<br>è«‹ç›´æ¥ã€Œé»æ“Šç•«é¢ã€å¹ç†„è Ÿç‡­";
        }
    }

    function detectBlow() {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        let blowCount = 0;
        
        function checkAudio() {
            if (isBlowing) {
                cancelAnimationFrame(animationId);
                return;
            }
            
            analyser.getByteFrequencyData(dataArray);
            let lowFreqSum = 0;
            // å°ˆæ³¨æ–¼ä½é »æ®µ
            for (let i = 0; i < bufferLength * 0.2; i++) {
                lowFreqSum += dataArray[i];
            }
            let average = lowFreqSum / (bufferLength * 0.2);

            if (average > 50) {
                blowCount++;
                if (blowCount > 3) {
                    triggerBlowOut();
                    return;
                }
            } else {
                blowCount = Math.max(0, blowCount - 1);
            }
            animationId = requestAnimationFrame(checkAudio);
        }
        animationId = requestAnimationFrame(checkAudio);
    }

    function manualBlow() {
        // å¦‚æœéŸ³æ¨‚é‚„æ²’æ’­å®Œå°±é»æ“Šï¼Œä¹Ÿå¯ä»¥è§¸ç™¼
        if (!isBlowing) triggerBlowOut();
    }

    // ========== 4. å¹ç†„è Ÿç‡­é‚è¼¯ ==========
    function triggerBlowOut() {
        if (isBlowing) return;
        isBlowing = true;
        
        // ç¢ºä¿éŸ³æ¨‚åœæ­¢
        happyBD.pause();
        
        cleanupMicrophone();
        blowHint.style.opacity = '0';

        // æ’­æ”¾å¹ç†„å½±ç‰‡
        timeline2.style.zIndex = '100';
        timeline2.classList.add('visible'); // ç¬é–“é¡¯ç¤º
        
        timeline2.play().then(() => {
            // Timeline2 é–‹å§‹æ’­ä¹‹å¾Œï¼ŒæŠŠ Timeline1 è—èµ·ä¾†
            setTimeout(() => {
                timeline1.classList.remove('visible');
                timeline1.pause();
            }, 200);
        }).catch(err => console.error("Timeline2 Play Error", err));

        timeline2.onended = () => {
            setTimeout(showCard, 500);
        };
    }

    function cleanupMicrophone() {
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        if (micStream) {
            micStream.getTracks().forEach(track => track.stop());
            micStream = null;
        }
        if (microphone) {
            microphone.disconnect();
            microphone = null;
        }
        // ä¸é—œé–‰ audioContextï¼Œå› ç‚ºå¾Œé¢é‚„æœ‰èƒŒæ™¯éŸ³æ¨‚è¦ç”¨
    }

    // ========== 5. é¡¯ç¤ºè³€å¡ ==========
    function showCard() {
        // --- [ä¿®æ­£é–‹å§‹] ---
        // 1. å°‡å½±ç‰‡å±¤ç´šé™åˆ°æœ€ä½ï¼Œä¸¦éš±è—
        timeline2.style.zIndex = '1'; 
        timeline2.style.opacity = '0';
        
        // 2. ç¢ºä¿è³€å¡å±¤ç´šæœ€é«˜ï¼Œä¸¦è¨­ç‚ºå¯è¦‹
        cardScreen.style.zIndex = '200'; 
        cardScreen.style.opacity = '1';
        cardScreen.style.pointerEvents = 'auto';
        // --- [ä¿®æ­£çµæŸ] ---

        if (bgm) {
            bgm.volume = 0.25;
            bgm.play().catch(() => {});
        }

        if (narration) {
            narration.volume = 1.0;
            narration.play().catch(() => {});
            narration.onended = () => {
                if (bgm) fadeBgmVolume(0.25, 0.8, 3000);
            };
        }

        // ç¢ºä¿åœ¨ç•«é¢æµ®ç¾å¾Œæ‰é–‹å§‹æ‰“å­—
        setTimeout(() => {
            typeWriter(greetingText, 0);
        }, 800);
        
        // é¡å¤–ä¿éšªï¼šéæ¸¡å‹•ç•«çµæŸå¾Œï¼Œå¾¹åº•éš±è—å½±ç‰‡ï¼Œé‡‹æ”¾è³‡æº
        setTimeout(() => {
            timeline2.style.display = 'none';
        }, 1000);
    }
    function typeWriter(text, index) {
        if (index >= text.length) {
            showSignature();
            return;
        }
        const char = text.charAt(index);
        if (char === '\n') {
            messageEl.appendChild(document.createElement('br'));
        } else {
            messageEl.appendChild(document.createTextNode(char));
        }

        let delay = 80;
        if (char === 'ï¼Œ' || char === 'ã€‚' || char === 'ï¼' || char === 'ï¼Ÿ') delay = 400;
        else if (char === '\n') delay = 600;

        setTimeout(() => typeWriter(text, index + 1), delay);
    }

    function showSignature() {
        setTimeout(() => {
            signature.style.opacity = '1';
            signaturePath.classList.add('animate');
        }, 1000);
    }

    function fadeBgmVolume(from, to, duration) {
        const steps = 50;
        const stepDuration = duration / steps;
        const increment = (to - from) / steps;
        let current = from;
        let step = 0;
        const fadeInterval = setInterval(() => {
            if (step >= steps) {
                clearInterval(fadeInterval);
                bgm.volume = to;
                return;
            }
            current += increment;
            bgm.volume = Math.max(0, Math.min(1, current));
            step++;
        }, stepDuration);
    }

    window.addEventListener('beforeunload', cleanupMicrophone);
</script>

</body>
</html>

