<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Make a Wish</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* 影片層設定 */
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        #timeline1 { z-index: 10; }
        #timeline2 { z-index: 5; }

        video.visible { opacity: 1; }

        /* 按鈕層 - 確保層級最高 */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999; /* 加高層級 */
            background: #000;
            transition: opacity 1s ease;
        }

        #wish-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 20px 40px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
            animation: pulse 2s infinite;
            -webkit-tap-highlight-color: transparent;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        }

        #card-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            transition: opacity 2s ease;
            padding: 40px;
            box-sizing: border-box;
            text-align: center;
        }

        #message {
            color: #fff;
            font-size: 1.3rem;
            line-height: 1.8;
            letter-spacing: 2px;
            margin-bottom: 30px;
            min-height: 100px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            white-space: pre-wrap; 
        }

        #signature {
            width: 150px;
            height: auto;
            opacity: 0;
            transition: opacity 2s ease;
        }
        
        path {
            fill: none;
            stroke: #d4af37;
            stroke-width: 2;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: sign 3s forwards;
            animation-play-state: paused;
        }
        
        @keyframes sign { to { stroke-dashoffset: 0; } }

        .hint {
            position: absolute;
            bottom: 10%;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 60;
            pointer-events: none;
        }

        #version-tag {
            position: absolute;
            bottom: 5px; right: 5px;
            color: rgba(255,255,255,0.3);
            font-size: 10px;
            z-index: 100;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="container">
    <div id="version-tag">Ver 12.0 (Stable Fix)</div>

    <video id="timeline1" src="timeline1.mp4?v=12" playsinline webkit-playsinline loop muted preload="auto"></video>
    <video id="timeline2" src="timeline2.mp4?v=12" playsinline webkit-playsinline muted preload="auto"></video>

    <div id="start-screen">
        <button id="wish-btn">按這裡許願<br><span style="font-size:0.8em; opacity:0.8;">許完願別忘了吹蠟燭 (大力吹)</span></button>
    </div>

    <div id="blow-hint" class="hint"></div>

    <div id="card-screen">
        <div id="message"></div> 
        <svg id="signature" viewBox="0 0 300 100">
            <path d="M40,80 Q50,10 60,80 Q70,40 80,60 L90,80 M95,60 L105,60 M110,80 L110,30 L120,80 M130,80 L130,30 L140,80 M150,60 Q160,50 170,60 T180,60 L190,60 Q200,50 190,70 T180,80" />
        </svg>
    </div>

    <audio id="narration" src="narration.mp3" preload="auto"></audio>
    <audio id="bgm" src="cute.mp3" preload="auto" loop></audio>

</div>

<script>
    const startScreen = document.getElementById('start-screen');
    const wishBtn = document.getElementById('wish-btn');
    const timeline1 = document.getElementById('timeline1');
    const timeline2 = document.getElementById('timeline2');
    const cardScreen = document.getElementById('card-screen');
    const messageEl = document.getElementById('message');
    const signature = document.getElementById('signature');
    const signaturePath = signature.querySelector('path');
    const narration = document.getElementById('narration');
    const bgm = document.getElementById('bgm');
    const blowHint = document.getElementById('blow-hint');
    
    let audioContext, analyser, microphone;
    let isBlowing = false;

    // --- 腳本設定區 (Ver 8.0 節奏) ---
    const greetingSequence = [
        { text: "北鼻，", speed: 250, pause: 500 }, 
        { text: "生日快樂！\n", speed: 150, pause: 1200 }, 
        { text: "感謝地心引力，\n", speed: 180, pause: 400 },
        { text: "讓妳在 12/12 走進我的生命。\n", speed: 160, pause: 1500 }, 
        { text: "溫柔的妳，", speed: 200, pause: 400 },
        { text: "總是讓我心疼、", speed: 180, pause: 200 },
        { text: "讓我瘋狂，\n", speed: 180, pause: 1200 },
        { text: "我會盡我全力，", speed: 180, pause: 300 },
        { text: "保護這樣的妳。\n", speed: 180, pause: 1800 }, 
        { text: "每天每天，", speed: 200, pause: 400 },
        { text: "都在一直想著妳...\n", speed: 220, pause: 1500 }, 
        { text: "1/7 見面，", speed: 160, pause: 500 },
        { text: "我會把欠妳的寵愛，\n", speed: 160, pause: 600 },
        { text: "「親自」", speed: 350, pause: 500 }, 
        { text: "送達。\n", speed: 150, pause: 1500 },
        { text: "乖乖等我喔！", speed: 150, pause: 0 }
    ];

    // --- 錯誤處理 (靜音模式) ---
    const handleError = (e, vName) => {
        console.warn(vName + " issue:", e);
    };
    timeline1.addEventListener('error', (e) => handleError(e, 't1'));
    timeline2.addEventListener('error', (e) => handleError(e, 't2'));

    // --- 1. 使用者點擊按鈕 (絕對安全模式) ---
    wishBtn.addEventListener('click', () => {
        // 第一步：先隱藏按鈕、播放影片 (確保視覺回饋)
        startScreen.style.opacity = '0';
        setTimeout(() => startScreen.style.display = 'none', 1000);
        
        timeline1.classList.add('visible');
        timeline1.play().catch(e => {
            timeline1.muted = true;
            timeline1.play();
        });

        // 第二步：顯示提示
        blowHint.innerHTML = "偵測麥克風中...請對著手機底部吹氣<br><span style='font-size:0.8em'>(若無法吹熄，請直接點擊畫面)</span>";
        blowHint.style.opacity = '1';

        // 第三步：嘗試解鎖聲音 (使用 try-catch 防止當機)
        tryUnlockAudio();

        // 第四步：備用點擊方案
        setTimeout(() => {
            document.addEventListener('click', manualBlowOut);
            document.addEventListener('touchstart', manualBlowOut);
        }, 1000);

        // 第五步：啟動麥克風
        initMicrophoneSafe();
    });

    // 安全解鎖音訊 (不會卡住主程式)
    function tryUnlockAudio() {
        if(timeline2) timeline2.play().then(() => { timeline2.pause(); timeline2.currentTime=0; }).catch(() => {});
        if(narration) narration.play().then(() => { narration.pause(); narration.currentTime=0; }).catch(() => {});
        // 背景音樂：如果有讀到就解鎖，讀不到就算了
        if(bgm) bgm.play().then(() => { bgm.pause(); bgm.currentTime=0; }).catch(() => {});
    }

    function manualBlowOut() {
        if (!isBlowing) triggerBlowOut();
    }

    async function initMicrophoneSafe() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 256;
            detectBlow();
        } catch (err) {
            blowHint.innerHTML = "麥克風無法啟用<br>請直接點擊螢幕吹熄蠟燭";
        }
    }

    function detectBlow() {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        function checkAudio() {
            if (isBlowing) return;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i = 0; i < bufferLength; i++) sum += dataArray[i];
            let average = sum / bufferLength;

            if (average > 45) { 
                triggerBlowOut();
            } else {
                requestAnimationFrame(checkAudio);
            }
        }
        checkAudio();
    }

    // --- 切換邏輯 ---
    function triggerBlowOut() {
        if(isBlowing) return;
        isBlowing = true;
        
        document.removeEventListener('click', manualBlowOut);
        document.removeEventListener('touchstart', manualBlowOut);
        blowHint.style.opacity = '0';

        timeline2.style.zIndex = "100"; 
        
        timeline2.play().then(() => {
            timeline2.classList.add('visible');
            setTimeout(() => {
                timeline1.classList.remove('visible');
                timeline1.pause();
            }, 100);
        }).catch(error => {
            alert("播放失敗: " + error.message);
        });

        timeline2.onended = () => {
            showCard();
        };
    }

    // --- 顯示賀卡 (包含音樂邏輯) ---
    function showCard() {
        timeline2.style.opacity = '0';
        cardScreen.style.opacity = '1';
        
        // 1. 播放背景音樂 (如果存在)
        if(bgm) {
            bgm.volume = 0.3; // 預設小聲
            bgm.play().catch(e => console.log("BGM play failed (ignoring)"));
        }

        // 2. 播放口白
        if(narration) {
            narration.volume = 1.0;
            narration.play().catch(e => console.log("Narration play failed"));
            
            // 3. 口白結束後，背景音樂漸強
            narration.onended = () => {
                if(bgm) fadeBgmIn();
            };
        }

        // 4. 無論音樂有沒有播成功，文字都要跑
        playSequence(0);
    }

    function fadeBgmIn() {
        let vol = 0.3;
        const fadeInterval = setInterval(() => {
            if (vol < 1.0) {
                vol += 0.05;
                bgm.volume = Math.min(vol, 1.0);
            } else {
                clearInterval(fadeInterval);
            }
        }, 200);
    }

    function playSequence(index) {
        if (index >= greetingSequence.length) {
            showSignature();
            return;
        }

        const segment = greetingSequence[index];
        typeWriterSegment(segment.text, 0, segment.speed, () => {
            setTimeout(() => {
                playSequence(index + 1);
            }, segment.pause || 0);
        });
    }

    function typeWriterSegment(text, i, speed, onComplete) {
        if (i < text.length) {
            messageEl.innerHTML += (text.charAt(i) === '\n') ? '<br>' : text.charAt(i);
            setTimeout(() => typeWriterSegment(text, i + 1, speed, onComplete), speed);
        } else {
            if (onComplete) onComplete();
        }
    }

    function showSignature() {
        signature.style.opacity = '1';
        signaturePath.style.animationPlayState = 'running';
    }
</script>

</body>
</html>
