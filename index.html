<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿæ—¥å¿«æ¨‚ ğŸ‚</title>
    
    <!-- é è¼‰é—œéµè³‡æº -->
    <link rel="preload" as="video" href="timeline1.mp4">
    <link rel="preload" as="audio" href="happyBD.mp3">
    
    <style>
        :root {
            --primary-gold: #ffd700;
            --transition-fast: 0.5s;
            --transition-slow: 2s;
            --transition-fade: 5s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #000;
        }

        /* å½±ç‰‡å±¤ */
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            will-change: opacity;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        #timeline1 { 
            z-index: 10; 
            opacity: 0; 
            transition: opacity var(--transition-fade) ease-in;
        }

        #timeline2 { 
            z-index: 20; 
            opacity: 0;
            transition: opacity var(--transition-fast) ease;
        }

        video.visible { opacity: 1 !important; }

        /* é–‹å§‹ç•«é¢ */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            background-color: #000;
            transition: opacity 1s ease;
        }

        #wish-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: #fff;
            padding: 25px 30px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            line-height: 1.6;
            text-align: center;
            max-width: 90%;
            transition: opacity 0.3s, transform 0.2s;
        }

        #wish-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
        }

        #wish-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1) translateZ(0); 
                box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3); 
            }
            50% { 
                transform: scale(1.05) translateZ(0); 
                box-shadow: 0 12px 48px rgba(255, 215, 0, 0.6); 
            }
        }

        #wish-btn span {
            display: block;
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 8px;
            color: var(--primary-gold);
        }

        /* è¼‰å…¥é€²åº¦ */
        #loading-progress {
            margin-top: 30px;
            color: rgba(255,255,255,0.7);
            font-size: 0.95rem;
            text-align: center;
            transition: opacity 0.5s;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin: 15px auto;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-gold), #fff);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--primary-gold);
        }

        /* æç¤ºæ–‡å­— */
        .hint {
            position: absolute;
            bottom: 15%;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.85);
            font-size: 1rem;
            opacity: 0;
            transition: opacity var(--transition-fast);
            z-index: 50;
            pointer-events: none;
            padding: 0 20px;
            line-height: 1.6;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* è³€å¡ç•«é¢ */
        #card-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            transition: opacity var(--transition-slow) ease;
            padding: 40px 30px;
        }

        #message {
            color: #fff;
            font-size: 1.35rem;
            line-height: 2;
            letter-spacing: 1.5px;
            margin-bottom: 40px;
            text-align: center;
            text-shadow: 0 2px 15px rgba(0,0,0,0.6);
            max-width: 90%;
        }

        #signature {
            width: 180px;
            height: auto;
            opacity: 0;
            transition: opacity var(--transition-slow) ease;
            margin-top: 20px;
        }
        
        #signature path {
            fill: none;
            stroke: var(--primary-gold);
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.5));
        }
        
        #signature path.animate {
            animation: sign 3s ease-out forwards;
        }
        
        @keyframes sign { 
            to { stroke-dashoffset: 0; } 
        }

        /* éŒ¯èª¤æç¤º */
        .error-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 50, 50, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 90%;
            text-align: center;
        }

        #version-tag {
            position: absolute;
            bottom: 8px;
            right: 8px;
            color: rgba(255,255,255,0.25);
            font-size: 10px;
            z-index: 100;
            pointer-events: none;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 480px) {
            #wish-btn {
                font-size: 1.1rem;
                padding: 20px 25px;
            }
            
            #message {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>

<div id="container">
    <div id="version-tag">Ver 18.2 (è·¨å¹³å°ä¿®æ­£)</div>

    <video id="timeline1" src="timeline1.mp4" playsinline webkit-playsinline loop muted preload="auto"></video>
    <video id="timeline2" src="timeline2.mp4" playsinline webkit-playsinline muted preload="auto"></video>

    <div id="start-screen">
        <button id="wish-btn" disabled>
            è¨±é¡˜
            <span>è¨±å®Œé¡˜æœ›è¦è¨˜å¾—å¹è Ÿç‡­å“¦<br>ï¼ˆå¯èƒ½è¦å¹å¤§åŠ›ä¸€é»XDï¼‰</span>
        </button>
        <div id="loading-progress">
            <div class="loading-spinner"></div>
            <div>è¼‰å…¥ä¸­... <span id="progress-percent">0</span>%</div>
            <div id="progress-bar">
                <div id="progress-fill"></div>
            </div>
        </div>
    </div>

    <div id="blow-hint" class="hint"></div>

    <div id="card-screen">
        <div id="message"></div>
        <svg id="signature" viewBox="0 0 320 120">
            <path d="M50,90 Q60,20 70,90 Q80,50 90,70 L100,90 M105,70 L115,70 M120,90 L120,40 L130,90 M140,90 L140,40 L150,90 M160,70 Q170,60 180,70 T190,70 L200,70 Q210,60 200,80 T190,90" />
        </svg>
    </div>

    <audio id="happyBD" src="happyBD.mp3" preload="auto"></audio>
    <audio id="narration" src="narration.mp3" preload="auto"></audio>
</div>

<script>
    // ========== å…ƒç´ å¿«å– ==========
    const elements = {
        startScreen: document.getElementById('start-screen'),
        wishBtn: document.getElementById('wish-btn'),
        timeline1: document.getElementById('timeline1'),
        timeline2: document.getElementById('timeline2'),
        cardScreen: document.getElementById('card-screen'),
        messageEl: document.getElementById('message'),
        signature: document.getElementById('signature'),
        signaturePath: document.querySelector('#signature path'),
        narration: document.getElementById('narration'),
        happyBD: document.getElementById('happyBD'),
        blowHint: document.getElementById('blow-hint'),
        loadingProgress: document.getElementById('loading-progress'),
        progressPercent: document.getElementById('progress-percent'),
        progressFill: document.getElementById('progress-fill')
    };
    
    let audioContext, analyser, microphone, micStream;
    let isBlowing = false;
    let animationId = null;
    let preloadComplete = false;

    const greetingText = `åŒ—é¼»,ç”Ÿæ—¥å¿«æ¨‚ï¼

æ„Ÿè¬åœ°å¿ƒå¼•åŠ›,
è®“å¦³åœ¨ 12/12 èµ°é€²æˆ‘çš„ç”Ÿå‘½ã€‚

æº«æŸ”çš„å¦³,
ç¸½æ˜¯è®“æˆ‘å¿ƒç–¼ã€è®“æˆ‘ç˜‹ç‹‚,
æˆ‘æœƒç›¡æˆ‘å…¨åŠ›,ä¿è­·é€™æ¨£çš„å¦³ã€‚

æ¯å¤©æ¯å¤©,éƒ½åœ¨ä¸€ç›´æƒ³è‘—å¦³...

1/7 è¦‹é¢,
æˆ‘æœƒæŠŠæ¬ å¦³çš„å¯µæ„›,ã€Œè¦ªè‡ªã€é€é”ã€‚

ä¹–ä¹–ç­‰æˆ‘å–”ï¼`;

    // ========== æª¢æŸ¥å®‰å…¨ç’°å¢ƒ ==========
    function checkSecureContext() {
        // æª¢æŸ¥æ˜¯å¦ç‚ºå®‰å…¨ç’°å¢ƒï¼ˆHTTPS æˆ– localhostï¼‰
        if (!window.isSecureContext) {
            showError('âš ï¸ éœ€è¦ HTTPS æ‰èƒ½ä½¿ç”¨éº¥å…‹é¢¨åŠŸèƒ½');
            console.error('ä¸æ˜¯å®‰å…¨ç’°å¢ƒï¼ŒgetUserMedia ç„¡æ³•ä½¿ç”¨');
            return false;
        }
        
        // æª¢æŸ¥ getUserMedia æ˜¯å¦å¯ç”¨
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showError('âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éº¥å…‹é¢¨åŠŸèƒ½');
            console.error('navigator.mediaDevices.getUserMedia ä¸å¯ç”¨');
            return false;
        }
        
        console.log('âœ… å®‰å…¨ç’°å¢ƒæª¢æŸ¥é€šé');
        return true;
    }

    // ========== é è¼‰ç³»çµ± ==========
    class MediaPreloader {
        constructor() {
            this.resources = [
                { id: 'timeline1', element: elements.timeline1, type: 'video', critical: true },
                { id: 'timeline2', element: elements.timeline2, type: 'video', critical: false },
                { id: 'happyBD', element: elements.happyBD, type: 'audio', critical: true },
                { id: 'narration', element: elements.narration, type: 'audio', critical: false }
            ];
            this.loaded = {};
            this.loadProgress = {};
        }

        async preloadAll(onProgress) {
            const promises = this.resources.map(resource => 
                this.preloadResource(resource, onProgress)
            );
            
            try {
                await Promise.all(promises);
                return true;
            } catch (error) {
                console.error('é è¼‰éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
                return false;
            }
        }

        preloadResource(resource, onProgress) {
            return new Promise((resolve) => {
                const element = resource.element;
                
                if (!element) {
                    console.warn(`æ‰¾ä¸åˆ°å…ƒç´ : ${resource.id}`);
                    this.loaded[resource.id] = true;
                    this.loadProgress[resource.id] = 100;
                    resolve();
                    return;
                }

                if (resource.type === 'video') {
                    element.preload = 'auto';
                }
                element.load();

                const updateProgress = () => {
                    try {
                        if (element.buffered.length > 0) {
                            const bufferedEnd = element.buffered.end(element.buffered.length - 1);
                            const duration = element.duration;
                            if (duration > 0 && !isNaN(duration)) {
                                this.loadProgress[resource.id] = (bufferedEnd / duration) * 100;
                                onProgress(this.getOverallProgress());
                            }
                        }
                    } catch (e) {}
                };

                element.addEventListener('progress', updateProgress);
                
                const canPlayHandler = () => {
                    this.loaded[resource.id] = true;
                    this.loadProgress[resource.id] = 100;
                    onProgress(this.getOverallProgress());
                    console.log(`${resource.id} è¼‰å…¥å®Œæˆ`);
                    resolve();
                };

                element.addEventListener('canplay', canPlayHandler, { once: true });

                element.addEventListener('error', (e) => {
                    console.error(`${resource.id} è¼‰å…¥å¤±æ•—:`, element.error);
                    
                    if (!resource.critical) {
                        console.warn(`${resource.id} éé—œéµè³‡æºï¼Œç¹¼çºŒåŸ·è¡Œ`);
                        this.loaded[resource.id] = true;
                        this.loadProgress[resource.id] = 100;
                        onProgress(this.getOverallProgress());
                        resolve();
                    } else {
                        showError(`${resource.id} è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆ`);
                        this.loaded[resource.id] = true;
                        resolve();
                    }
                }, { once: true });

                setTimeout(() => {
                    if (!this.loaded[resource.id]) {
                        console.warn(`${resource.id} è¼‰å…¥è¶…æ™‚ï¼Œå¼·åˆ¶ç¹¼çºŒ`);
                        this.loaded[resource.id] = true;
                        this.loadProgress[resource.id] = 100;
                        onProgress(this.getOverallProgress());
                        resolve();
                    }
                }, 10000);

                setTimeout(() => {
                    if (!this.loaded[resource.id] && element.readyState >= 2) {
                        console.log(`${resource.id} å·²æœ‰è¶³å¤ æ•¸æ“šï¼Œæå‰å®Œæˆ`);
                        canPlayHandler();
                    }
                }, 2000);
            });
        }

        getOverallProgress() {
            const ids = this.resources.map(r => r.id);
            let totalProgress = 0;
            
            ids.forEach(id => {
                totalProgress += (this.loadProgress[id] || 0);
            });
            
            return Math.round(totalProgress / ids.length);
        }
    }

    // ========== éŒ¯èª¤è™•ç† ==========
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            errorDiv.style.opacity = '0';
            setTimeout(() => errorDiv.remove(), 500);
        }, 5000);
    }

    // ========== åˆå§‹åŒ–é è¼‰ ==========
    const preloader = new MediaPreloader();

    window.addEventListener('load', () => {
        console.log('é–‹å§‹é è¼‰åª’é«”æª”æ¡ˆ...');
        console.log('ç•¶å‰ç’°å¢ƒ:', window.location.protocol);
        
        // æª¢æŸ¥å®‰å…¨ç’°å¢ƒ
        checkSecureContext();
        
        preloader.preloadAll((progress) => {
            elements.progressPercent.textContent = progress;
            elements.progressFill.style.width = progress + '%';
            
            if (progress >= 80) {
                preloadComplete = true;
                setTimeout(() => {
                    elements.loadingProgress.style.opacity = '0';
                    elements.wishBtn.disabled = false;
                    elements.wishBtn.style.opacity = '1';
                    console.log('é è¼‰å®Œæˆï¼Œå¯ä»¥é–‹å§‹äº†ï¼');
                }, 500);
            }
        }).then((success) => {
            if (success) {
                console.log('æ‰€æœ‰åª’é«”é è¼‰å®Œæˆ');
            }
        });

        setTimeout(() => {
            if (!preloadComplete) {
                console.warn('é è¼‰è¶…æ™‚ï¼Œå¼·åˆ¶å•Ÿç”¨');
                preloadComplete = true;
                elements.loadingProgress.style.opacity = '0';
                elements.wishBtn.disabled = false;
                elements.wishBtn.style.opacity = '1';
            }
        }, 15000);
    });

    // ========== é–‹å§‹é«”é©— ==========
    elements.wishBtn.addEventListener('click', startExperience, { once: true });

    function startExperience() {
        if (!preloadComplete) {
            showError('æª”æ¡ˆå°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™...');
            return;
        }

        console.log('é–‹å§‹ç”Ÿæ—¥é©šå–œé«”é©—ï¼');
        elements.wishBtn.style.animation = 'none';
        
        elements.startScreen.style.opacity = '0';
        setTimeout(() => { 
            elements.startScreen.style.display = 'none'; 
        }, 1000);
        
        if (elements.happyBD) {
            elements.happyBD.volume = 1.0;
            elements.happyBD.play().catch(e => {
                console.warn("éŸ³æ¨‚æ’­æ”¾å¤±æ•—", e);
                showError('éŸ³æ¨‚æ’­æ”¾å¤±æ•—ï¼Œè«‹é»æ“Šç•«é¢é‡è©¦');
            });
        }

        elements.timeline1.muted = true;
        elements.timeline1.play().then(() => {
            console.log("Timeline1 é–‹å§‹æ’­æ”¾");
            elements.timeline1.offsetHeight;
            elements.timeline1.classList.add('visible');
        }).catch(err => {
            console.error("Timeline1 æ’­æ”¾å¤±æ•—:", err);
            elements.timeline1.style.opacity = '1';
        });

        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch(e) { 
            console.log("AudioContext åˆå§‹åŒ–è­¦å‘Š"); 
        }

        unlockAudio();

        setTimeout(() => {
            document.addEventListener('click', manualBlow, { once: true });
            document.addEventListener('touchstart', manualBlow, { once: true });
        }, 3000);
    }

    // ========== éŸ³æ¨‚çµæŸå¾Œå•Ÿå‹•éº¥å…‹é¢¨ ==========
    elements.happyBD.addEventListener('ended', () => {
        if (!isBlowing) {
            console.log("ç”Ÿæ—¥å¿«æ¨‚æ­ŒçµæŸï¼Œè«‹æ±‚éº¥å…‹é¢¨æ¬Šé™...");
            elements.blowHint.innerHTML = "ç¾åœ¨ï¼Œè«‹å°è‘—éº¥å…‹é¢¨å¹æ°£<br>æŠŠè Ÿç‡­å¹ç†„å§ï¼";
            elements.blowHint.style.opacity = '1';
            initMicrophone();
        }
    });

    function unlockAudio() {
        [elements.timeline2, elements.narration].forEach(media => {
            if (media) {
                media.play().then(() => {
                    media.pause();
                    media.currentTime = 0;
                }).catch(() => {});
            }
        });
    }

    // ========== éº¥å…‹é¢¨åµæ¸¬ï¼ˆå¼·åŒ–ç‰ˆï¼‰ ==========
    async function initMicrophone() {
        // å†æ¬¡æª¢æŸ¥ç’°å¢ƒ
        if (!checkSecureContext()) {
            elements.blowHint.innerHTML = "âš ï¸ éœ€è¦ HTTPS æ‰èƒ½ä½¿ç”¨éº¥å…‹é¢¨<br>è«‹ç›´æ¥ã€Œé»æ“Šç•«é¢ã€å¹ç†„è Ÿç‡­";
            return;
        }

        try {
            console.log('ğŸ¤ è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™...');
            
            micStream = await navigator.mediaDevices.getUserMedia({ 
                audio: { 
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false 
                }
            });
            
            console.log('âœ… éº¥å…‹é¢¨æ¬Šé™å·²ç²å¾—');
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(micStream);
            microphone.connect(analyser);
            analyser.fftSize = 512;
            analyser.smoothingTimeConstant = 0.3;
            
            console.log("éº¥å…‹é¢¨å•Ÿå‹•æˆåŠŸï¼Œé–‹å§‹åµæ¸¬å¹æ°£");
            detectBlow();
            
        } catch (err) {
            console.error('éº¥å…‹é¢¨å•Ÿå‹•å¤±æ•—:', err);
            
            // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
            if (err.name === 'NotAllowedError') {
                elements.blowHint.innerHTML = "éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•<br>è«‹ç›´æ¥ã€Œé»æ“Šç•«é¢ã€å¹ç†„è Ÿç‡­";
            } else if (err.name === 'NotFoundError') {
                elements.blowHint.innerHTML = "æ‰¾ä¸åˆ°éº¥å…‹é¢¨è£ç½®<br>è«‹ç›´æ¥ã€Œé»æ“Šç•«é¢ã€å¹ç†„è Ÿç‡­";
            } else {
                elements.blowHint.innerHTML = "éº¥å…‹é¢¨ç„¡æ³•å•Ÿå‹•<br>è«‹ç›´æ¥ã€Œé»æ“Šç•«é¢ã€å¹ç†„è Ÿç‡­";
            }
        }
    }

    function detectBlow() {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        let blowCount = 0;
        
        function checkAudio() {
            if (isBlowing) {
                cancelAnimationFrame(animationId);
                return;
            }
            
            analyser.getByteFrequencyData(dataArray);
            let lowFreqSum = 0;
            
            for (let i = 0; i < bufferLength * 0.2; i++) {
                lowFreqSum += dataArray[i];
            }
            let average = lowFreqSum / (bufferLength * 0.2);

            if (average > 50) {
                blowCount++;
                console.log(`ğŸŒ¬ï¸ åµæ¸¬åˆ°å¹æ°£ (${blowCount}/4)`);
                if (blowCount > 3) {
                    triggerBlowOut();
                    return;
                }
            } else {
                blowCount = Math.max(0, blowCount - 1);
            }
            
            animationId = requestAnimationFrame(checkAudio);
        }
        
        animationId = requestAnimationFrame(checkAudio);
    }

    function manualBlow() {
        if (!isBlowing) {
            console.log('ğŸ‘† æ‰‹å‹•è§¸ç™¼å¹ç†„');
            triggerBlowOut();
        }
    }

    // ========== å¹ç†„è Ÿç‡­ ==========
    function triggerBlowOut() {
        if (isBlowing) return;
        isBlowing = true;
        
        console.log("ğŸ‚ è Ÿç‡­è¢«å¹ç†„ï¼");
        
        elements.happyBD.pause();
        cleanupMicrophone();
        elements.blowHint.style.opacity = '0';

        elements.timeline2.style.zIndex = '100';
        elements.timeline2.classList.add('visible');
        
        elements.timeline2.play().then(() => {
            setTimeout(() => {
                elements.timeline1.classList.remove('visible');
                elements.timeline1.pause();
            }, 200);
        }).catch(err => {
            console.error("Timeline2 æ’­æ”¾éŒ¯èª¤", err);
            showCard();
        });

        elements.timeline2.addEventListener('ended', () => {
            setTimeout(showCard, 500);
        }, { once: true });
    }

    function cleanupMicrophone() {
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        if (micStream) {
            micStream.getTracks().forEach(track => track.stop());
            micStream = null;
        }
        if (microphone) {
            microphone.disconnect();
            microphone = null;
        }
    }

    // ========== é¡¯ç¤ºè³€å¡ ==========
    function showCard() {
        console.log("ğŸ’Œ é¡¯ç¤ºè³€å¡");
        
        elements.timeline2.style.zIndex = '1'; 
        elements.timeline2.style.opacity = '0';
        
        elements.cardScreen.style.zIndex = '200'; 
        elements.cardScreen.style.opacity = '1';
        elements.cardScreen.style.pointerEvents = 'auto';

        if (elements.narration) {
            elements.narration.volume = 1.0;
            elements.narration.play().catch(e => {
                console.warn("æ—ç™½æ’­æ”¾å¤±æ•—", e);
            });
        }

        setTimeout(() => {
            typeWriter(greetingText, 0);
        }, 800);
        
        setTimeout(() => {
            elements.timeline2.style.display = 'none';
            elements.timeline1.style.display = 'none';
        }, 2000);
    }

    function typeWriter(text, index) {
        if (index >= text.length) {
            showSignature();
            return;
        }
        
        const char = text.charAt(index);
        if (char === '\n') {
            elements.messageEl.appendChild(document.createElement('br'));
        } else {
            elements.messageEl.appendChild(document.createTextNode(char));
        }

        let delay = 80;
        if (char === ',' || char === 'ã€‚' || char === 'ï¼' || char === 'ï¼Ÿ') {
            delay = 400;
        } else if (char === '\n') {
            delay = 600;
        }

        setTimeout(() => typeWriter(text, index + 1), delay);
    }

    function showSignature() {
        setTimeout(() => {
            elements.signature.style.opacity = '1';
            elements.signaturePath.classList.add('animate');
        }, 1000);
    }

    // ========== æ¸…ç†è³‡æº ==========
    window.addEventListener('beforeunload', cleanupMicro
